<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>flash</title>
<link rel="stylesheet" href="doc.css">
</head>
<body>
<h1>flash</h1>
<pre class="forth">
<font color=black>
<hr>

</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>SPI flash access 

</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>Flash addresses are doubles to support 16-bit and 18-bit cell size. 
</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>Compiled strings (for `type` etc.) are assumed to have 0 for the upper cell 
</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>of the address. Those strings must be below flash address 2^cellsize. 

</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>Single-byte reads from flash close the SPI flash after reading. 
</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>There is no assumption of continuity: Font bitmaps may be read between bytes. 
</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>So, c@f is slow. If you need speed, read flash in chunks. 

</font><font color=#00AAAA><a href = "root.html#1.1290" style="text-decoration: none; color: #00AAAA">there</a> <a href = "root.html#1.1120" style="text-decoration: none; color: #00AAAA">hex</a> 

</font><font color=#00AAAA><a href = "root.html#1.1210" style="text-decoration: none; color: #00AAAA">:</a> </font><font color=#FF0000>_isp  </font><font color=#00AAAA><a href = "root.html#1.1010" style="text-decoration: none; color: #00AAAA">(</a> </font><font color=#008800>c --  )              &nbsp;</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>write ISP byte to SPIF 
  &nbsp;</font><font color=#00AAAA><a href = "root.html#1.1170" style="text-decoration: none; color: #00AAAA">[</a> </font><font color=#AA0000>4 </font><font color=#0000FF><a href = "forth.html#2.0170" style="text-decoration: none; color: #0000FF">cells</a> </font><font color=#00AAAA><a href = "root.html#1.1180" style="text-decoration: none; color: #00AAAA">]</a> <a href = "root.html#1.1260" style="text-decoration: none; color: #00AAAA">literal</a> </font><font color=#0000FF><a href = "forth.html#2.0120" style="text-decoration: none; color: #0000FF">io!</a> 
</font><font color=#00AAAA><a href = "root.html#1.1240" style="text-decoration: none; color: #00AAAA">;</a> 
</font><font color=#00AAAA><a href = "root.html#1.1210" style="text-decoration: none; color: #00AAAA">:</a> </font><font color=#FF0000>ispwait  </font><font color=#00AAAA><a href = "root.html#1.1010" style="text-decoration: none; color: #00AAAA">(</a> </font><font color=#008800>--  )             &nbsp;</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>wait for ISP command to finish 
  &nbsp;</font><font color=#00AAAA><a href = "root.html#1.2900" style="text-decoration: none; color: #00AAAA">begin</a>  <a href = "root.html#1.1170" style="text-decoration: none; color: #00AAAA">[</a> </font><font color=#AA0000>4 </font><font color=#0000FF><a href = "forth.html#2.0170" style="text-decoration: none; color: #0000FF">cells</a> </font><font color=#00AAAA><a href = "root.html#1.1180" style="text-decoration: none; color: #00AAAA">]</a> <a href = "root.html#1.1260" style="text-decoration: none; color: #00AAAA">literal</a> </font><font color=#0000FF><a href = "forth.html#2.0110" style="text-decoration: none; color: #0000FF">io@</a>  </font><font color=#00AAAA><a href = "root.html#1.2960" style="text-decoration: none; color: #00AAAA">while</a>  </font><font color=#0000FF><a href = "forth.html#2.0100" style="text-decoration: none; color: #0000FF">noop</a>  </font><font color=#00AAAA><a href = "root.html#1.2970" style="text-decoration: none; color: #00AAAA">repeat</a> 
</font><font color=#00AAAA><a href = "root.html#1.1240" style="text-decoration: none; color: #00AAAA">;</a> 
</font><font color=#00AAAA><a href = "root.html#1.1210" style="text-decoration: none; color: #00AAAA">:</a> </font><font color=#FF0000>ispcmd  </font><font color=#00AAAA><a href = "root.html#1.1010" style="text-decoration: none; color: #00AAAA">(</a> </font><font color=#008800>c --  )            &nbsp;</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>write ISP command 
  &nbsp;</font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">_isp</a> <a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">ispwait</a> 
</font><font color=#00AAAA><a href = "root.html#1.1240" style="text-decoration: none; color: #00AAAA">;</a> 
</font><font color=#00AAAA><a href = "root.html#1.1210" style="text-decoration: none; color: #00AAAA">:</a> </font><font color=#FF0000>fabyte  </font><font color=#00AAAA><a href = "root.html#1.1010" style="text-decoration: none; color: #00AAAA">(</a> </font><font color=#008800>faddr shift -- faddr  )
  &nbsp;</font><font color=#FF00FF><a href = "root.html#1.2170" style="text-decoration: none; color: #FF00FF">>r</a>  </font><font color=#0000FF><a href = "forth.html#2.0330" style="text-decoration: none; color: #0000FF">2dup</a>  </font><font color=#FF00FF><a href = "root.html#1.2180" style="text-decoration: none; color: #FF00FF">r></a> </font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">drshift</a> </font><font color=#FF00FF><a href = "root.html#1.2130" style="text-decoration: none; color: #FF00FF">drop</a> </font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">ispcmd</a> 
</font><font color=#00AAAA><a href = "root.html#1.1240" style="text-decoration: none; color: #00AAAA">;</a> 
</font><font color=#00AAAA><a href = "root.html#1.1210" style="text-decoration: none; color: #00AAAA">:</a> </font><font color=#FF0000>fcmd24  </font><font color=#00AAAA><a href = "root.html#1.1010" style="text-decoration: none; color: #00AAAA">(</a> </font><font color=#008800>faddr cmd --  )    &nbsp;</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>set start address and set command 
  &nbsp;</font><font color=#AA0000>0 </font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">_isp</a>  </font><font color=#AA0000>3 </font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">_isp</a>  </font><font color=#AA0000>82 </font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">_isp</a>     &nbsp;</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>4 bytes to send 
  &nbsp;</font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">ispcmd</a>  </font><font color=#AA0000>10 </font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">fabyte</a>  </font><font color=#AA0000>8 </font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">fabyte</a>  </font><font color=#AA0000>0 </font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">fabyte</a> 
  &nbsp;</font><font color=#0000FF><a href = "forth.html#2.0340" style="text-decoration: none; color: #0000FF">2drop</a> 
</font><font color=#00AAAA><a href = "root.html#1.1240" style="text-decoration: none; color: #00AAAA">;</a> 
</font><font color=#00AAAA><a href = "root.html#1.1210" style="text-decoration: none; color: #00AAAA">:</a> </font><font color=#FF0000>c@f  </font><font color=#00AAAA><a href = "root.html#1.1010" style="text-decoration: none; color: #00AAAA">(</a> </font><font color=#008800>faddr -- c  )
  &nbsp;</font><font color=#AA0000>0B </font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">fcmd24</a>  </font><font color=#AA0000>82 </font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">_isp</a>  </font><font color=#AA0000>0 </font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">ispcmd</a> </font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>start read command with dummy 
  &nbsp;</font><font color=#AA0000>60 </font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">ispcmd</a>                   &nbsp;</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>trigger SPI transfer 
  &nbsp;</font><font color=#00AAAA><a href = "root.html#1.1170" style="text-decoration: none; color: #00AAAA">[</a> </font><font color=#AA0000>3 </font><font color=#0000FF><a href = "forth.html#2.0170" style="text-decoration: none; color: #0000FF">cells</a> </font><font color=#00AAAA><a href = "root.html#1.1180" style="text-decoration: none; color: #00AAAA">]</a> <a href = "root.html#1.1260" style="text-decoration: none; color: #00AAAA">literal</a> </font><font color=#0000FF><a href = "forth.html#2.0110" style="text-decoration: none; color: #0000FF">io@</a>     &nbsp;</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>read SPI result 
  &nbsp;</font><font color=#AA0000>80 </font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">_isp</a>                     &nbsp;</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>end read 
</font><font color=#00AAAA><a href = "root.html#1.1240" style="text-decoration: none; color: #00AAAA">;</a> 
</font><font color=#00AAAA><a href = "root.html#1.1210" style="text-decoration: none; color: #00AAAA">:</a> </font><font color=#FF0000>fcount  </font><font color=#00AAAA><a href = "root.html#1.1010" style="text-decoration: none; color: #00AAAA">(</a> </font><font color=#008800>faddr -- faddr+1 c  )
  &nbsp;</font><font color=#0000FF><a href = "forth.html#2.0330" style="text-decoration: none; color: #0000FF">2dup</a> </font><font color=#AA0000>1 0 </font><font color=#0000FF><a href = "forth.html#2.1130" style="text-decoration: none; color: #0000FF">d+</a>  <a href = "forth.html#2.1190" style="text-decoration: none; color: #0000FF">2swap</a> <a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">c@f</a> 
</font><font color=#00AAAA><a href = "root.html#1.1240" style="text-decoration: none; color: #00AAAA">;</a> 
</font><font color=#00AAAA><a href = "root.html#1.1210" style="text-decoration: none; color: #00AAAA">:</a> </font><font color=#FF0000>ftype  </font><font color=#00AAAA><a href = "root.html#1.1010" style="text-decoration: none; color: #00AAAA">(</a> </font><font color=#008800>faddr u --  )       &nbsp;</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>emit string in flash 
  &nbsp;</font><font color=#FF00FF><a href = "root.html#1.2100" style="text-decoration: none; color: #FF00FF">dup</a> </font><font color=#00AAAA><a href = "root.html#1.2930" style="text-decoration: none; color: #00AAAA">if</a> 
     &nbsp;</font><font color=#00AAAA><a href = "root.html#1.2980" style="text-decoration: none; color: #00AAAA">for</a>  </font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">fcount</a> <a href = "forth.html#2.2110" style="text-decoration: none; color: #0000FF">emit</a>  </font><font color=#00AAAA><a href = "root.html#1.2990" style="text-decoration: none; color: #00AAAA">next</a> 
  &nbsp;</font><font color=#00AAAA><a href = "root.html#1.2950" style="text-decoration: none; color: #00AAAA">then</a>  </font><font color=#0000FF><a href = "forth.html#2.0340" style="text-decoration: none; color: #0000FF">2drop</a> 
</font><font color=#00AAAA><a href = "root.html#1.1240" style="text-decoration: none; color: #00AAAA">;</a> 
</font><font color=#00AAAA><a href = "root.html#1.1210" style="text-decoration: none; color: #00AAAA">:</a> </font><font color=#FF0000>f$type  </font><font color=#00AAAA><a href = "root.html#1.1010" style="text-decoration: none; color: #00AAAA">(</a> </font><font color=#008800>sfaddr --  )       &nbsp;</font><font color=#00AAAA><a href = "root.html#1.1020" style="text-decoration: none; color: #00AAAA">\</a> </font><font color=#008800>emit the "flash string" 
  &nbsp;</font><font color=#AA0000>0  </font><font color=#0000FF><a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">fcount</a>  <a href = "forth.html#(null)" style="text-decoration: none; color: #0000FF">ftype</a> 
</font><font color=#00AAAA><a href = "root.html#1.1240" style="text-decoration: none; color: #00AAAA">;</a> 

</font><font color=#00AAAA><a href = "root.html#1.1110" style="text-decoration: none; color: #00AAAA">decimal</a> <a href = "root.html#1.1290" style="text-decoration: none; color: #00AAAA">there</a> </font><font color=#FF00FF><a href = "root.html#1.2120" style="text-decoration: none; color: #FF00FF">swap</a> <a href = "root.html#1.2090" style="text-decoration: none; color: #FF00FF">-</a> </font><font color=#00AAAA><a href = "root.html#1.0400" style="text-decoration: none; color: #00AAAA">.</a> <a href = "root.html#1.1030" style="text-decoration: none; color: #00AAAA">.(</a> </font><font color=#008800>instructions used by flash )</font><font color=#0000FF><a href = "forth.html#2.2111" style="text-decoration: none; color: #0000FF">cr</a> 

</pre>
</body>
</html>
